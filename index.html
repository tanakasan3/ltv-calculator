<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LTV Calculator</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #1a1a2e;
            color: #e0e0e0;
        }
        .container {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 380px;
            padding: 35px;
            background: #16213e;
            box-shadow: 2px 0 5px rgba(0,0,0,0.3);
        }
        .main {
            flex: 1;
            padding: 35px;
            overflow-x: auto;
        }
        h1 {
            margin-top: 0;
            color: #f39c12;
            font-size: 1.8em;
        }
        h2 {
            font-size: 0.9em;
            color: #a0a0a0;
            margin: 15px 0 8px 0;
            font-weight: 600;
        }
        p {
            color: #888;
            line-height: 1.5;
        }
        select, input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #333;
            border-radius: 4px;
            font-size: 14px;
            background: #0f0f23;
            color: #e0e0e0;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #f39c12;
        }
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 5px;
        }
        .radio-group label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 14px;
            color: #e0e0e0;
        }
        .section-divider {
            border-top: 1px solid #333;
            margin: 25px 0;
            padding-top: 10px;
        }
        table {
            width: 100%;
            max-width: 900px;
            border-collapse: collapse;
            background: #16213e;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            border-radius: 4px;
            overflow: hidden;
        }
        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #1a1a2e;
        }
        th {
            background: #0f0f23;
            font-weight: 600;
            color: #888;
        }
        tr:last-child td {
            border-bottom: none;
        }
        tr.section-header td {
            background: #0f3460;
            font-weight: 600;
            color: #f39c12;
        }
        tr.subsection-header td {
            background: #1a1a2e;
            font-weight: 600;
            color: #3498db;
        }
        tr.highlight td {
            background: #3d2914;
        }
        tr.output-highlight td {
            background: #1e4620;
            font-weight: 500;
        }
        .loading {
            text-align: center;
            padding: 50px;
            color: #888;
        }
        @keyframes flash {
            0% { background-color: #f39c12; color: #000; }
            100% { background-color: transparent; color: inherit; }
        }
        .flash {
            animation: flash 0.6s ease-out;
        }
        @media (max-width: 900px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h1>âš¡ LTV Calculator</h1>
            <p>Prototype showing calculated LTVs based on probabilistic expectations.</p>
            <p>What-if scenarios based on the following inputs.</p>

            <h2>Liquidation Recovery APR:</h2>
            <select id="liquidation-apr"></select>

            <div class="section-divider"></div>

            <h2>Margin Call to Liquidation Time Period:</h2>
            <select id="mc-to-liq-time-period">
                <option value="1-day">1-day</option>
                <option value="3-days" selected>3-days</option>
                <option value="1-week">1-week</option>
            </select>

            <h2>Margin Call to Liquidation Confidence Level:</h2>
            <select id="mc-to-liq-confidence-level">
                <option value="95%" selected>95%</option>
                <option value="99%">99%</option>
                <option value="99.9%">99.9%</option>
                <option value="99.99%">99.99%</option>
            </select>

            <h2>Margin Call to Liquidation Time Horizon:</h2>
            <select id="mc-to-liq-time-horizon">
                <option value="30">30 samples</option>
                <option value="60">60 samples</option>
                <option value="90">90 samples</option>
                <option value="100" selected>100 samples</option>
                <option value="120">120 samples</option>
            </select>

            <h2>Margin Call to Liquidation use VaR? CVaR?:</h2>
            <div class="radio-group">
                <label><input type="radio" name="mc-to-liq-var" value="true"> VaR</label>
                <label><input type="radio" name="mc-to-liq-var" value="false" checked> CVaR</label>
            </div>

            <div class="section-divider"></div>

            <h2>Initial to first Margin Call Time Period:</h2>
            <select id="init-to-mc-time-period">
                <option value="1-week">1-week</option>
                <option value="2-weeks">2-weeks</option>
                <option value="3-weeks">3-weeks</option>
                <option value="1-month">1-month</option>
                <option value="3-month">3-month</option>
                <option value="6-month">6-month</option>
                <option value="1-year" selected>1-year</option>
            </select>

            <h2>Initial to first Margin Call Confidence Level:</h2>
            <select id="init-to-mc-confidence-level">
                <option value="95%" selected>95%</option>
                <option value="99%">99%</option>
                <option value="99.9%">99.9%</option>
                <option value="99.99%">99.99%</option>
            </select>

            <h2>Initial to first Margin Call Time Horizon:</h2>
            <select id="init-to-mc-time-horizon">
                <option value="30">30 samples</option>
                <option value="60">60 samples</option>
                <option value="90">90 samples</option>
                <option value="100" selected>100 samples</option>
                <option value="120">120 samples</option>
            </select>

            <h2>Initial to first Margin Call use VaR? CVaR?:</h2>
            <div class="radio-group">
                <label><input type="radio" name="init-to-mc-var" value="true"> VaR</label>
                <label><input type="radio" name="init-to-mc-var" value="false" checked> CVaR</label>
            </div>
        </div>

        <div class="main">
            <div id="output" class="loading">Loading BTC price data...</div>
        </div>
    </div>

    <script>
        let btcData = [];
        let previousValues = {};

        // Populate APR dropdown
        const aprSelect = document.getElementById('liquidation-apr');
        const step = 0.005;
        for (let apr = 0.05; apr <= 0.25 + step/2; apr += step) {
            const option = document.createElement('option');
            option.value = apr.toFixed(3);
            option.textContent = (apr * 100).toFixed(2) + '%';
            if (Math.abs(apr - 0.10) < step/2) option.selected = true;
            aprSelect.appendChild(option);
        }

        // Calculate log returns for a given shift
        function calcLogReturns(closes, shift) {
            const returns = [];
            for (let i = 0; i < closes.length - shift; i++) {
                const logRet = Math.log(closes[i + shift] / closes[i]);
                returns.push(logRet);
            }
            return returns;
        }

        // Calculate percentile (for VaR)
        function percentile(arr, p) {
            const sorted = [...arr].sort((a, b) => a - b);
            const idx = (p / 100) * (sorted.length - 1);
            const lower = Math.floor(idx);
            const upper = Math.ceil(idx);
            if (lower === upper) return sorted[lower];
            return sorted[lower] + (idx - lower) * (sorted[upper] - sorted[lower]);
        }

        // Calculate standard deviation
        function std(arr) {
            const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
            const sqDiffs = arr.map(x => Math.pow(x - mean, 2));
            return Math.sqrt(sqDiffs.reduce((a, b) => a + b, 0) / arr.length);
        }

        // Calculate mean
        function mean(arr) {
            return arr.reduce((a, b) => a + b, 0) / arr.length;
        }

        // Get shift days for time period
        function getShiftDays(period) {
            const map = {
                '1-day': 1,
                '3-days': 3,
                '1-week': 7,
                '2-weeks': 14,
                '3-weeks': 21,
                '1-month': 28,
                '3-month': 84,
                '6-month': 168,
                '1-year': 336
            };
            return map[period] || 1;
        }

        // Get confidence level percentile
        function getConfidencePercentile(cl) {
            const map = {
                '95%': 5,
                '99%': 1,
                '99.9%': 0.1,
                '99.99%': 0.01
            };
            return map[cl] || 5;
        }

        // Format percentage
        function formatPct(val, decimals = 2) {
            return (val * 100).toFixed(decimals) + '%';
        }

        // Main calculation
        function calculate() {
            if (btcData.length === 0) return;

            const closes = btcData.map(d => d.close);

            // Get inputs
            const apr = parseFloat(document.getElementById('liquidation-apr').value);
            
            const mcToLiqPeriod = document.getElementById('mc-to-liq-time-period').value;
            const mcToLiqCL = document.getElementById('mc-to-liq-confidence-level').value;
            const mcToLiqHorizon = parseInt(document.getElementById('mc-to-liq-time-horizon').value);
            const mcToLiqUseVar = document.querySelector('input[name="mc-to-liq-var"]:checked').value === 'true';

            const initToMcPeriod = document.getElementById('init-to-mc-time-period').value;
            const initToMcCL = document.getElementById('init-to-mc-confidence-level').value;
            const initToMcHorizon = parseInt(document.getElementById('init-to-mc-time-horizon').value);
            const initToMcUseVar = document.querySelector('input[name="init-to-mc-var"]:checked').value === 'true';

            // Calculate log returns
            const mcToLiqReturns = calcLogReturns(closes, getShiftDays(mcToLiqPeriod));
            const initToMcReturns = calcLogReturns(closes, getShiftDays(initToMcPeriod));

            // Get tail samples
            const mcToLiqTail = mcToLiqReturns.slice(-mcToLiqHorizon);
            const initToMcTail = initToMcReturns.slice(-initToMcHorizon);

            // Calculate volatility
            const mcToLiqVol = std(mcToLiqTail);
            const initToMcVol = std(initToMcTail);

            // Calculate VaR
            const mcToLiqVaR = percentile(mcToLiqTail, getConfidencePercentile(mcToLiqCL));
            const initToMcVaR = percentile(initToMcTail, getConfidencePercentile(initToMcCL));

            // Calculate CVaR (mean of values below VaR)
            const mcToLiqCVaR = mean(mcToLiqTail.filter(x => x < mcToLiqVaR));
            const initToMcCVaR = mean(initToMcTail.filter(x => x < initToMcVaR));

            // Expected loss
            const mcToLiqLoss = Math.abs(mcToLiqUseVar ? mcToLiqVaR : mcToLiqCVaR);
            const initToMcLoss = Math.abs(initToMcUseVar ? initToMcVaR : initToMcCVaR);

            // CVL / LTV calculations
            const liquidationCVL = 1 + apr;
            const liquidationLTV = 1 / liquidationCVL;

            const marginCallCVL = 1 + apr + mcToLiqLoss;
            const marginCallLTV = 1 / marginCallCVL;

            const initialCVL = 1 + apr + mcToLiqLoss + initToMcLoss;
            const initialLTV = 1 / initialCVL;

            // Store current values for comparison
            const currentValues = {
                apr: formatPct(apr),
                mcToLiqPeriod,
                mcToLiqCL,
                mcToLiqHorizon: mcToLiqHorizon + ' samples',
                mcToLiqMethod: mcToLiqUseVar ? 'VaR' : 'CVaR',
                mcToLiqVol: formatPct(mcToLiqVol),
                initToMcPeriod,
                initToMcCL,
                initToMcHorizon: initToMcHorizon + ' samples',
                initToMcMethod: initToMcUseVar ? 'VaR' : 'CVaR',
                initToMcVol: formatPct(initToMcVol),
                initialCVL: formatPct(initialCVL, 0),
                marginCallCVL: formatPct(marginCallCVL, 0),
                liquidationCVL: formatPct(liquidationCVL, 0),
                initialLTV: formatPct(initialLTV, 0),
                marginCallLTV: formatPct(marginCallLTV, 0),
                liquidationLTV: formatPct(liquidationLTV, 0),
                mcVol: formatPct(mcToLiqVol),
                mcVaR: formatPct(mcToLiqVaR),
                mcCVaR: formatPct(mcToLiqCVaR),
                mcLoss: formatPct(mcToLiqLoss),
                initVol: formatPct(initToMcVol),
                initVaR: formatPct(initToMcVaR),
                initCVaR: formatPct(initToMcCVaR),
                initLoss: formatPct(initToMcLoss),
            };

            // Build output table
            const rows = [
                { type: 'section', label: 'CVLs / LTVs Calculations' },
                { type: 'section', label: 'Inputs' },
                { field: 'Liquidation Recovery APR', value: currentValues.apr, key: 'apr' },
                { type: 'empty' },
                { field: 'Margin Call - Time Period', value: currentValues.mcToLiqPeriod, key: 'mcToLiqPeriod' },
                { field: 'Margin Call - Confidence Level', value: currentValues.mcToLiqCL, key: 'mcToLiqCL' },
                { field: 'Margin Call - Time Horizon', value: currentValues.mcToLiqHorizon, key: 'mcToLiqHorizon' },
                { field: 'Margin Call - Loss estimation using:', value: currentValues.mcToLiqMethod, key: 'mcToLiqMethod' },
                { field: 'Margin Call - Implied Volatility', value: currentValues.mcToLiqVol, key: 'mcToLiqVol' },
                { type: 'empty' },
                { field: 'Initial - Time Period', value: currentValues.initToMcPeriod, key: 'initToMcPeriod' },
                { field: 'Initial - Confidence Level', value: currentValues.initToMcCL, key: 'initToMcCL' },
                { field: 'Initial - Time Horizon', value: currentValues.initToMcHorizon, key: 'initToMcHorizon' },
                { field: 'Initial - Loss estimation using:', value: currentValues.initToMcMethod, key: 'initToMcMethod' },
                { field: 'Initial - Implied Volatility', value: currentValues.initToMcVol, key: 'initToMcVol' },
                { type: 'empty' },
                { type: 'section', label: 'Outputs' },
                { type: 'cvl-ltv', label: 'Initial', cvl: currentValues.initialCVL, ltv: currentValues.initialLTV, cvlKey: 'initialCVL', ltvKey: 'initialLTV' },
                { type: 'cvl-ltv', label: 'Margin Call', cvl: currentValues.marginCallCVL, ltv: currentValues.marginCallLTV, cvlKey: 'marginCallCVL', ltvKey: 'marginCallLTV' },
                { type: 'cvl-ltv', label: 'Liquidation', cvl: currentValues.liquidationCVL, ltv: currentValues.liquidationLTV, cvlKey: 'liquidationCVL', ltvKey: 'liquidationLTV' },
                { type: 'empty' },
                { type: 'section', label: 'Details' },
                { field: 'Margin Call - Vol', value: currentValues.mcVol, key: 'mcVol' },
                { field: 'Margin Call - VaR', value: currentValues.mcVaR, key: 'mcVaR' },
                { field: 'Margin Call - CVaR', value: currentValues.mcCVaR, key: 'mcCVaR' },
                { field: 'Margin Call - Expected Loss', value: currentValues.mcLoss, key: 'mcLoss' },
                { type: 'empty' },
                { field: 'Initial - Vol', value: currentValues.initVol, key: 'initVol' },
                { field: 'Initial - VaR', value: currentValues.initVaR, key: 'initVaR' },
                { field: 'Initial - CVaR', value: currentValues.initCVaR, key: 'initCVaR' },
                { field: 'Initial - Expected Loss', value: currentValues.initLoss, key: 'initLoss' },
            ];

            let html = '<table><tbody>';
            for (const row of rows) {
                if (row.type === 'section') {
                    html += `<tr class="section-header"><td colspan="3">${row.label}</td></tr>`;
                } else if (row.type === 'subsection') {
                    html += `<tr class="subsection-header"><td colspan="3">${row.label}</td></tr>`;
                } else if (row.type === 'empty') {
                    html += `<tr><td>&nbsp;</td><td></td><td></td></tr>`;
                } else if (row.type === 'cvl-ltv') {
                    const cvlChanged = previousValues[row.cvlKey] && previousValues[row.cvlKey] !== row.cvl;
                    const ltvChanged = previousValues[row.ltvKey] && previousValues[row.ltvKey] !== row.ltv;
                    const cvlFlash = cvlChanged ? ' class="flash"' : '';
                    const ltvFlash = ltvChanged ? ' class="flash"' : '';
                    html += `<tr class="output-highlight"><td>${row.label}</td><td${cvlFlash}>${row.cvl}</td><td${ltvFlash}>${row.ltv}</td></tr>`;
                } else {
                    const changed = previousValues[row.key] && previousValues[row.key] !== row.value;
                    const flashClass = changed ? ' class="flash"' : '';
                    html += `<tr><td>${row.field}</td><td${flashClass} colspan="2">${row.value}</td></tr>`;
                }
            }
            html += '</tbody></table>';

            // Add header row for outputs section
            html = html.replace(
                '<tr class="section-header"><td colspan="3">Outputs</td></tr>',
                '<tr class="section-header"><td colspan="3">Outputs</td></tr><tr class="subsection-header"><td></td><td>CVL</td><td>LTV</td></tr>'
            );

            document.getElementById('output').innerHTML = html;
            
            // Store values for next comparison
            previousValues = { ...currentValues };
        }

        // Load data and setup
        fetch('btc_data.json')
            .then(r => r.json())
            .then(data => {
                btcData = data;
                calculate();

                // Add event listeners
                document.querySelectorAll('select, input[type="radio"]').forEach(el => {
                    el.addEventListener('change', calculate);
                });
            })
            .catch(err => {
                document.getElementById('output').innerHTML = 
                    '<p style="color: #e74c3c;">Error loading data: ' + err.message + '</p>';
            });
    </script>
</body>
</html>
